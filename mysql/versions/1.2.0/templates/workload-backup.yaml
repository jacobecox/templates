{{- if .Values.backup.enabled }}
kind: workload
name: {{ .Release.Name }}-mysql-backup
description: MySQL Backup
tags:
  {{- include "mysql.tags" . | nindent 2 }}
spec:
  type: cron
  containers:
    - name: backup-mysql
      cpu: {{ .Values.backup.resources.cpu }}
      memory: {{ .Values.backup.resources.memory }}
      env:
      {{- if .Values.backup.aws.enabled }}
        - name: AWS_REGION
          value: cpln://secret/{{ .Release.Name }}-mysql-config.aws-region
        - name: BACKUP_PROVIDER
          value: aws
        - name: BACKUP_BUCKET
          value: cpln://secret/{{ .Release.Name }}-mysql-config.backup-bucket
        - name: BACKUP_PREFIX
          value: {{ .Values.backup.aws.s3.prefix }}
      {{- end }}
      {{- if .Values.backup.gcp.enabled }}
        - name: BACKUP_PROVIDER
          value: gcp
        - name: BACKUP_BUCKET
          value: cpln://secret/{{ .Release.Name }}-mysql-config.backup-bucket
        - name: BACKUP_PREFIX
          value: {{ .Values.backup.gcp.gcs.prefix }}
      {{- end }}
        - name: MYSQL_HOST
          value: {{ .Release.Name }}-mysql.{{ .Values.global.cpln.gvc }}.cpln.local
        - name: MYSQL_PASSWORD
          value: cpln://secret/{{ .Release.Name }}-mysql-config.password
        - name: MYSQL_PORT
          value: '3306'
        - name: MYSQL_USER
          value: cpln://secret/{{ .Release.Name }}-mysql-config.username
      image: /org/jacob-cox/image/mysql-backup:0.1 # CHANGE ME
      inheritEnv: false
  defaultOptions:
    autoscaling:
      maxConcurrency: 0
      maxScale: 1
      metric: concurrency
      minScale: 1
      scaleToZeroDelay: 300
      target: 95
    capacityAI: false
    debug: false
    suspend: false
    timeoutSeconds: 5
  firewallConfig:
    external:
      inboundAllowCIDR: []
      inboundBlockedCIDR: []
      outboundAllowCIDR:
        - 0.0.0.0/0
      outboundAllowHostname: []
      outboundAllowPort: []
      outboundBlockedCIDR: []
    internal:
      inboundAllowType: none
      inboundAllowWorkload: []
  identityLink: //identity/{{ .Release.Name }}-mysql-identity
  job:
    concurrencyPolicy: Forbid
    historyLimit: 5
    restartPolicy: Never
    schedule: {{ .Values.backup.schedule }}
  supportDynamicTags: false
{{- end }}