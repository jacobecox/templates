---
kind: secret
name: {{ .Release.Name }}-cassandra-startup
description: {{ .Release.Name }}-cassandra-startup
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    # --- Replica info ---
    LOCATION=$(basename "${CPLN_LOCATION:-}")
    HOSTNAME=${HOSTNAME:-}
    GVC="{{ .Values.gvc.name }}"
    WORKLOAD_NAME="{{ .Release.Name }}"
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    SELF_FQDN="replica-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"
    SELF_IP=$(ip addr show eth0 | grep "inet " | awk '{print $2}' | cut -d/ -f1)

    # --- Directories ---
    CONFIG_DIR="/etc/cassandra"
    CONFIG_FILE="$CONFIG_DIR/cassandra.yaml"
    ENV_FILE="$CONFIG_DIR/cassandra-env.sh"
    DATA_DIR="/var/lib/cassandra"
    LOG_DIR="/var/log/cassandra"

    mkdir -p "$CONFIG_DIR" "$DATA_DIR" "$LOG_DIR"

    # --- Prepare locations from Helm values ---
    IFS=',' read -r -a LOCATIONS <<< "${LOCATIONS_STR:-}"

    # --- Generate cassandra.yaml ---
    cat > "$CONFIG_FILE" <<EOF
    cluster_name: 'ControlPlaneCluster'
    num_tokens: 256
    listen_address: $SELF_FQDN
    rpc_address: 0.0.0.0
    broadcast_address: $SELF_FQDN
    broadcast_rpc_address: $SELF_FQDN
    endpoint_snitch: GossipingPropertyFileSnitch
    data_file_directories:
      - $DATA_DIR/data
    commitlog_directory: $DATA_DIR/commitlog
    commitlog_sync: periodic
    commitlog_sync_period_in_ms: 10000
    saved_caches_directory: $DATA_DIR/saved_caches
    partitioner: org.apache.cassandra.dht.Murmur3Partitioner
    EOF

    # --- Generate seeds using locationsfrom values.yaml ---
    SEEDS=(
      {{- range $i, $loc := .Values.gvc.locations }}
      "replica-0.{{ $.Release.Name }}.{{ $loc.name }}.{{ $.Values.gvc.name }}.cpln.local"
      {{- end }}
    )
    SEEDS_STR=$(IFS=, ; echo "${SEEDS[*]}")

    # Append seeds to config
    cat >> "$CONFIG_FILE" <<EOF
    seed_provider:
      - class_name: org.apache.cassandra.locator.SimpleSeedProvider
        parameters:
          - seeds: "$SEEDS_STR"
    EOF

    # --- Generate cassandra-env.sh for heap sizes ---
    cat > "$ENV_FILE" <<EOF
    #!/usr/bin/env bash
    MAX_HEAP_SIZE=${MAX_HEAP_SIZE:-512M}
    HEAP_NEWSIZE=${HEAP_NEWSIZE:-1G}
    EOF

    chmod +x "$ENV_FILE"

    echo "Generated Cassandra config at $CONFIG_FILE:"
    cat "$CONFIG_FILE"
    echo
    echo "Generated Cassandra env at $ENV_FILE:"
    cat "$ENV_FILE"

    sleep 10000

    exec cassandra -f -R
