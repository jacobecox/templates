---
kind: secret
name: {{ .Release.Name }}-cassandra-startup
description: {{ .Release.Name }}-cassandra-startup
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    # --- Replica info ---
    LOCATION=$(basename "${CPLN_LOCATION:-}")
    HOSTNAME=${HOSTNAME:-}
    GVC="{{ .Values.gvc.name }}"
    WORKLOAD_NAME="{{ .Release.Name }}-cassandra"
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    SELF_FQDN="cassandra-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"

    # --- Directories ---
    CONFIG_DIR="/etc/cassandra"
    CONFIG_FILE="$CONFIG_DIR/cassandra.yaml"
    ENV_FILE="$CONFIG_DIR/cassandra-env.sh"
    DATA_DIR="/var/lib/cassandra"
    LOG_DIR="/var/log/cassandra"

    mkdir -p "$CONFIG_DIR" "$DATA_DIR" "$LOG_DIR"

    # --- Prepare locations from Helm values ---
    IFS=',' read -r -a LOCATIONS <<< "${LOCATIONS_STR:-}"

    # --- Generate cassandra.yaml ---
    cat > "$CONFIG_FILE" <<EOF
    cluster_name: 'ControlPlaneCluster'
    num_tokens: 256
    listen_address: $SELF_FQDN
    rpc_address: 0.0.0.0
    endpoint_snitch: GossipingPropertyFileSnitch
    data_file_directories:
      - $DATA_DIR/data
    commitlog_directory: $DATA_DIR/commitlog
    saved_caches_directory: $DATA_DIR/saved_caches
    EOF

    # --- Generate seeds list (replica-0 for first 3 locations) ---
    SEEDS=()
    for LOC_PAIR in "${LOCATIONS[@]:0:3}"; do
        LOC="${LOC_PAIR%%:*}"
        SEEDS+=("replica-0.${WORKLOAD_NAME}.${LOC}.${GVC}.cpln.local")
    done
    SEEDS_STR=$(IFS=, ; echo "${SEEDS[*]}")

    # Append seeds to config
    cat >> "$CONFIG_FILE" <<EOF
    seed_provider:
      - class_name: org.apache.cassandra.locator.SimpleSeedProvider
        parameters:
          - seeds: "$SEEDS_STR"
    EOF

    # --- Generate cassandra-env.sh for heap sizes ---
    cat > "$ENV_FILE" <<EOF
    #!/usr/bin/env bash
    MAX_HEAP_SIZE=${MAX_HEAP_SIZE:-512M}
    HEAP_NEWSIZE=${HEAP_NEWSIZE:-128M}
    EOF

    chmod +x "$ENV_FILE"

    echo "Generated Cassandra config at $CONFIG_FILE:"
    cat "$CONFIG_FILE"
    echo
    echo "Generated Cassandra env at $ENV_FILE:"
    cat "$ENV_FILE"

    # --- Start Cassandra ---
    exec cassandra -f -R
