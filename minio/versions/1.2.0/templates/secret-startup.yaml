kind: secret
name: {{ include "minio.secretStartupName" . }}
description: MinIO startup config
tags: {{- include "minio.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    INDEX=${HOSTNAME##*-}
    LOCATION=$(basename "${CPLN_LOCATION}")
    DOMAIN="{{ include "minio.name" . }}.${LOCATION}.{{ .Values.global.cpln.gvc }}.cpln.local"

    # Append mapping (LOCAL_IP already provided by default variable)
    echo "$LOCAL_IP replica-${INDEX}.${DOMAIN}" >> /etc/hosts

    # Build distributed server list dynamically
    SERVER_ARGS=""
    {{- $replicas := int .Values.replicas }}
    {{- range $i, $ := until $replicas }}
    SERVER_ARGS="$SERVER_ARGS http://replica-{{ $i }}.${DOMAIN}/data"
    {{- end }}

    echo "Starting MinIO node index $INDEX with endpoints:"
    echo "$SERVER_ARGS"

    exec minio server \
      $SERVER_ARGS \
      --console-address :9001