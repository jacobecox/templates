---
kind: secret
name: {{ .Release.Name }}-tidb-pd-startup
description: {{ .Release.Name }} TiDB placement driver startup script
tags: {{- include "tidb.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    LOCATION=$(basename "${CPLN_LOCATION}")
    HOSTNAME=${HOSTNAME}
    GVC="{{ .Values.gvc.name }}"
    WORKLOAD_NAME="{{ .Release.Name }}-pd"
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    SELF_FQDN="replica-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"

    # Parse LOCATIONS into individual location variables
    IFS=',' read -ra LOC_ARRAY <<< "$LOCATIONS"
    FIRST_LOCATION="${LOC_ARRAY[0]}"
    SECOND_LOCATION="${LOC_ARRAY[1]}"
    BOOTSTRAP_FQDN="replica-0.${WORKLOAD_NAME}.${FIRST_LOCATION}.${GVC}.cpln.local"
    SECONDARY_FQDN="replica-0.${WORKLOAD_NAME}.${SECOND_LOCATION}.${GVC}.cpln.local"

    mkdir -p /data /etc/pd

    IS_BOOTSTRAP=false
    FORCE_NEW_CLUSTER=false
    HAS_DATA=false
    if [[ -d "/data/member" && $(find /data/member -type f 2>/dev/null | wc -l) -gt 0 ]]; then
      HAS_DATA=true
    fi

    if [[ "$LOCATION" == "$FIRST_LOCATION" && "$REPLICA_INDEX" == "0" ]]; then
        IS_BOOTSTRAP=true
        echo "This is the primary bootstrap replica."

        if [[ "$HAS_DATA" == "true" ]]; then
            echo "Persistent data found. Normal startup."
            FORCE_NEW_CLUSTER=false
        else
            echo "No persistent data found. Bootstrapping new cluster."
            FORCE_NEW_CLUSTER=true
        fi
    else
        echo "This replica will join the existing cluster via ${BOOTSTRAP_FQDN}"
    fi

    # Base PD config
    cat > /etc/pd/pd.toml <<EOF
    name = "${LOCATION}-${REPLICA_INDEX}"
    data-dir = "/data"
    client-urls = "http://0.0.0.0:2379"
    peer-urls   = "http://0.0.0.0:2380"
    advertise-client-urls = "http://${SELF_FQDN}:2379"
    advertise-peer-urls   = "http://${SELF_FQDN}:2380"
    EOF

    if [[ "$HAS_DATA" == "true" ]]; then
        echo "Existing PD data detected â€” regenerating clean config.toml"
        rm -f /etc/pd/pd.toml

    # Recreate a clean pd.toml file
        cat > /etc/pd/pd.toml <<EOF
    name = "${LOCATION}-${REPLICA_INDEX}"
    data-dir = "/data"
    client-urls = "http://0.0.0.0:2379"
    peer-urls   = "http://0.0.0.0:2380"
    advertise-client-urls = "http://${SELF_FQDN}:2379"
    advertise-peer-urls   = "http://${SELF_FQDN}:2380"
    initial-cluster-state = "existing"

    election-interval = "20000ms"
    tick-interval = "500ms"
    lease = 15
    
    [replication]
    location-labels = ["region"]

    [labels]
    region = "${LOCATION}"

    [log]
    level = "info"

    [metric]
    interval = "5s"
    EOF

        if [[ "$IS_BOOTSTRAP" == "true" ]]; then
            echo "initial-cluster = \"$SECOND_LOCATION-0=http://${SECONDARY_FQDN}:2380\"" >> /etc/pd/pd.toml
            echo "joining with $SECONDARY_FQDN"
        else
            echo "initial-cluster = \"$FIRST_LOCATION-0=http://${BOOTSTRAP_FQDN}:2380\"" >> /etc/pd/pd.toml
            echo "joining with $BOOTSTRAP_FQDN"
        fi
    else
        if [[ "$IS_BOOTSTRAP" == "true" && "$FORCE_NEW_CLUSTER" == "true" ]]; then
            echo 'initial-cluster-state = "new"' >> /etc/pd/pd.toml
        fi
    fi

    # Retry Helper Function
    retry_start_existing() {
      local attempt=1
      local max_attempts=3
      local delay=10
      while (( attempt <= max_attempts )); do
        echo "Attempt $attempt to start PD with existing data..."
        /pd-server --config=/etc/pd/pd.toml && return 0
        echo "Startup attempt $attempt failed. Retrying in ${delay}s..."
        sleep $delay
        ((attempt++))
      done
      echo "All restart attempts failed after ${max_attempts} tries. Exiting."
      exit 1
    }

    # Start PD
    if [[ "$IS_BOOTSTRAP" == "true" ]]; then
        if [[ "$FORCE_NEW_CLUSTER" == "true" ]]; then
            echo "Starting PD bootstrap with --force-new-cluster"
            exec /pd-server --config=/etc/pd/pd.toml --force-new-cluster
        else
            echo "Starting PD bootstrap normally (no --join)"
            exec /pd-server --config=/etc/pd/pd.toml
        fi
    else
        if [[ "$HAS_DATA" == "true" ]]; then
            echo "Persistent data found. Starting normally (existing cluster)."
            retry_start_existing
        else
            echo "Waiting for bootstrap PD to become healthy..."
            until curl -sf "http://${BOOTSTRAP_FQDN}:2379/pd/api/v1/health" \
                    | jq -e '.[0].health == true' >/dev/null \
                  && curl -sf "http://${BOOTSTRAP_FQDN}:2379/pd/api/v1/leader" \
                    | jq -e '.member_id' >/dev/null \
                  && curl -sf "http://${BOOTSTRAP_FQDN}:2379/pd/api/v1/members" \
                    | jq -e '.members | length >= 1' >/dev/null; do
                echo "Bootstrap PD not ready yet (waiting for at least 1 member)..."
                sleep 5
            done

            echo "Bootstrap PD is healthy. Joining cluster."
            exec /pd-server --config=/etc/pd/pd.toml --join="http://${BOOTSTRAP_FQDN}:2379"
        fi
    fi