---
kind: secret
name: {{ .Release.Name }}-tidb-server-startup
description: {{ .Release.Name }} TiDB server startup script
tags: {{- include "tidb.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    LOCATION=$(basename "${CPLN_LOCATION}")
    HOSTNAME=${HOSTNAME}
    GVC="{{ .Values.gvc.name }}"
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    WORKLOAD_NAME="{{ .Release.Name }}-server"
    SELF_FQDN="replica-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"
    PRIMARY_LOCATION="{{ (index .Values.gvc.locations 0).name }}"

    JOIN_PDS=""
    LOCATIONS="{{ range .Values.gvc.locations }}{{ .name }} {{ end }}"
    for loc in $LOCATIONS; do
        pd_host="replica-0.{{ .Release.Name }}-pd.${loc}.${GVC}.cpln.local:2379"
        JOIN_PDS="${JOIN_PDS},${pd_host}"
    done
    JOIN_PDS=${JOIN_PDS#,}

    echo "PD endpoints: ${JOIN_PDS}"

    INIT_SQL_FLAG=""

    if [[ "${LOCATION}" == "${PRIMARY_LOCATION}" && "${REPLICA_INDEX}" == "0" ]]; then
      echo "This is the primary init TiDB server (${LOCATION}, replica-0). Running init SQL."
      INIT_SQL_FLAG="--initialize-sql-file=/etc/tidb/init/init.sql"
    else
      echo "Not primary init server (${LOCATION}, replica-${REPLICA_INDEX}). Skipping init SQL."
    fi

    # Generate TiDB config
    mkdir -p /etc/tidb
    cat > /etc/tidb/tidb.toml <<EOF
    lease = "45s"

    [log]
    level = "info"

    [status]
    status-host = "0.0.0.0"
    status-port = 10080

    [pd-client]
    pd-server-timeout = 120
    EOF

    # Database initialization
    ROOT_PW="$ROOT_PW"
    APP_USER="$APP_USER"
    APP_PW="$APP_PW"
    APP_DB="$APP_DB"

    mkdir -p /etc/tidb/init
    cat > /etc/tidb/init/init.sql <<EOF
    ALTER USER 'root'@'%' IDENTIFIED BY '${ROOT_PW}';

    CREATE DATABASE IF NOT EXISTS `${APP_DB}`;

    CREATE USER IF NOT EXISTS '${APP_USER}'@'%' IDENTIFIED BY '${APP_PW}';
    GRANT ALL PRIVILEGES ON `${APP_DB}`.* TO '${APP_USER}'@'%';
    FLUSH PRIVILEGES;

    CREATE PLACEMENT POLICY IF NOT EXISTS `${APP_DB}_survive_location_failure`
      FOLLOWERS = 2
      CONSTRAINTS = '[+zone]'
      SCHEDULE = 'EVEN';

    ALTER DATABASE `${APP_DB}`
      PLACEMENT POLICY = `${APP_DB}_survive_location_failure`;
    EOF

    echo "Starting TiDB server..."
    exec /tidb-server \
      --config /etc/tidb/tidb.toml \
      --path="${JOIN_PDS}" \
      --store="tikv" \
      --advertise-address="${SELF_FQDN}" \
      ${INIT_SQL_FLAG}