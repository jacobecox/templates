---
kind: secret
name: {{ .Release.Name }}-tidb-server-startup
description: {{ .Release.Name }} TiDB server startup script
tags: {{- include "tidb.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    LOCATION=$(basename "${CPLN_LOCATION}")
    GVC="{{ .Values.gvc.name }}"

    JOIN_PDS=""
    LOCATIONS="{{ range .Values.gvc.locations }}{{ .name }} {{ end }}"
    for loc in $LOCATIONS; do
      JOIN_PDS="${JOIN_PDS},replica-0.{{ .Release.Name }}-pd.${loc}.${GVC}.cpln.local:2379"
    done
    JOIN_PDS=${JOIN_PDS#,}

    mkdir -p /etc/tidb
    cat > /etc/tidb/tidb.toml <<EOF
    lease = "45s"

    [log]
    level = "info"

    [status]
    status-host = "0.0.0.0"
    status-port = 10080

    [pd-client]
    pd-server-timeout = 120
    EOF

    exec /tidb-server \
      --config /etc/tidb/tidb.toml \
      --path="${JOIN_PDS}" \
      --store="tikv"