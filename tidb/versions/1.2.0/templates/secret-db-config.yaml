{{ if .Values.autoCreateDatabase.enabled }}
---
kind: secret
name: {{ .Release.Name }}-tidb-user
description: {{ .Release.Name }} tidb user
tags: {{- include "tidb.tags" . | nindent 4 }}
type: dictionary
data:
  rootPassword: {{ .Values.autoCreateDatabase.database.rootPassword }}
  user: {{ .Values.autoCreateDatabase.database.user }}
  password: {{ .Values.autoCreateDatabase.database.password }}
  db: {{ .Values.autoCreateDatabase.database.db }}

---
kind: secret
name: {{ .Release.Name }}-tidb-db-init
description: {{ .Release.Name }} TiDB database initialization
tags: {{- include "tidb.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |
    #!/usr/bin/env bash
    set -euo pipefail

    echo "Waiting for TiDB MySQL endpoint at ${TIDB_HOST}:${TIDB_PORT}..."

    # Fast-exit if DB already exists (idempotency guard)
    if mysql -h "${TIDB_HOST}" -P "${TIDB_PORT}" -u root -p"${ROOT_PW}" \
      -e "USE \`${APP_DB}\`" >/dev/null 2>&1; then
      echo "Database already initialized. Exiting."
      exit 0
    fi

    READY=false
    for i in {1..60}; do
      if mysql -h "${TIDB_HOST}" -P "${TIDB_PORT}" -u root -e "SELECT 1" >/dev/null 2>&1; then
        READY=true
        break
      fi

      echo "TiDB not ready yet, retrying in 5s..."
      sleep 5
    done

    if [[ "${READY}" != "true" ]]; then
      echo "ERROR: TiDB MySQL endpoint never became ready"
      exit 1
    fi

    echo "TiDB reachable with default root auth."

    # ---- Phase 1: bootstrap using passwordless root ----

    mysql -h "${TIDB_HOST}" -P "${TIDB_PORT}" -u root <<EOF
    ALTER USER 'root'@'%' IDENTIFIED BY '${ROOT_PW}';

    CREATE DATABASE IF NOT EXISTS \`${APP_DB}\`;

    DROP USER IF EXISTS '${APP_USER}'@'%';
    CREATE USER '${APP_USER}'@'%' IDENTIFIED BY '${APP_PW}';
    GRANT ALL PRIVILEGES ON \`${APP_DB}\`.* TO '${APP_USER}'@'%';
    EOF

    echo "Bootstrap complete. Root password set."

    # ---- Optional Phase 2: verify password auth ----

    mysql -h "${TIDB_HOST}" -P "${TIDB_PORT}" -u root -p"${ROOT_PW}" -e "SELECT 1" >/dev/null

    echo "Verified root password authentication."
    echo "TiDB database initialization complete."
{{ end }}