---
kind: secret
name: {{ .Release.Name }}-tidb-tikv-startup
description: {{ .Release.Name }} TiDB tikv startup script
tags: {{- include "tidb.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    # Basic environment setup
    LOCATION=$(basename "${CPLN_LOCATION}")
    HOSTNAME=${HOSTNAME}
    GVC="{{ .Values.gvc.name }}"
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    WORKLOAD_NAME="{{ .Release.Name }}-tikv"
    SELF_FQDN="replica-${REPLICA_INDEX}.${WORKLOAD_NAME}.${LOCATION}.${GVC}.cpln.local"

    # Build PD endpoint list dynamically
    PD_ENDPOINTS=""
    LOCATIONS="{{ range .Values.gvc.locations }}{{ .name }} {{ end }}"
    for loc in $LOCATIONS; do
        endpoint="replica-0.{{ .Release.Name }}-pd.${loc}.${GVC}.cpln.local:2379"
        PD_ENDPOINTS="${PD_ENDPOINTS},${endpoint}"
    done
    PD_ENDPOINTS=${PD_ENDPOINTS#,}

    # Create TiKV config
    echo "Generating /etc/tikv/tikv.toml for ${SELF_FQDN}"
    mkdir -p /etc/tikv
    cat > /etc/tikv/tikv.toml <<EOF
    [server]
    addr = "0.0.0.0:20160"
    advertise-addr = "${SELF_FQDN}:20160"

    [labels]
    zone = "${LOCATION}"

    [log]
    level = "info"

    [storage]
    data-dir = "/data"
    reserve-space = "0GB"

    [pd]
    endpoints = ["${PD_ENDPOINTS//,/\",\"}"]

    [raftstore]
    raftdb-path = "/data/raft"

    [rocksdb]
    wal-dir = "/data/wal"
    EOF

    # Retry Helper Function
    retry_start_tikv() {
      local attempt=1
      local max_attempts=3
      local delay=10
      while (( attempt <= max_attempts )); do
        echo "Attempt $attempt to start TiKV..."
        /tikv-server --config /etc/tikv/tikv.toml && return 0
        echo "TiKV startup attempt $attempt failed (non-zero or timed out). Retrying in ${delay}s..."
        sleep $delay
        ((attempt++))
      done
      echo "All TiKV restart attempts failed after ${max_attempts} tries. Exiting."
      exit 1
    }

    echo "Starting TiKV with retry logic..."
    retry_start_tikv