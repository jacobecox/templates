---
kind: secret
name: {{ .Release.Name }}-fusionauth-startup
description: FusionAuth startup script
tags: {{- include "fusionauth.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/bin/bash
    set -euo pipefail

    DB_HOST="{{ .Release.Name }}-postgres.{{ .Values.global.cpln.gvc }}.cpln.local"
    DB_PORT=5432
    MAX_RETRIES=60
    SLEEP_SECONDS=5

    echo "Waiting for PostgreSQL to accept connections at ${DB_HOST}:${DB_PORT}..."

    for i in $(seq 1 $MAX_RETRIES); do
      if pg_isready -h "$DB_HOST" -p "$DB_PORT" >/dev/null 2>&1; then
        echo "PostgreSQL is ready!"
        break
      fi
      echo "Attempt $i/$MAX_RETRIES: Postgres not ready yet, retrying in ${SLEEP_SECONDS}s..."
      sleep "$SLEEP_SECONDS"
    done

    if ! pg_isready -h "$DB_HOST" -p "$DB_PORT" >/dev/null 2>&1; then
      echo "PostgreSQL did not become ready after $((MAX_RETRIES * SLEEP_SECONDS))s. Exiting."
      exit 1
    fi

    echo "Starting FusionAuth..."
    exec /usr/local/fusionauth/fusionauth-app/bin/start.sh