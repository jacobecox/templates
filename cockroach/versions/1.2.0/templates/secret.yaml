---
kind: secret
name: {{ include "cockroach.secretStartupName" . }}
description: CockroachDB startup script
tags: {{- include "cockroach.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |- 
    #!/usr/bin/env bash
    set -euo pipefail

    # Runtime env provided by Control Plane
    LOCATION=$(basename "${CPLN_LOCATION}")
    HOSTNAME=${HOSTNAME}

    # Extract replica index + workload from HOSTNAME
    REPLICA_INDEX=$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')
    GVC="{{ .Values.gvc.name }}"

    # Self FQDN
    SELF_FQDN="replica-${REPLICA_INDEX}.{{ include "cockroach.name" . }}.${LOCATION}.${GVC}.cpln.local"

    # Build join list at runtime
    JOIN_HOSTS=""
    LOCATIONS="{{ range .Values.gvc.locations }}{{ .name }} {{ end }}"
    REPLICAS="{{ range .Values.gvc.locations }}{{ .replicas }} {{ end }}"

    loc_index=0
    for loc in $LOCATIONS; do
      replica_count=$(echo $REPLICAS | cut -d' ' -f$((loc_index + 1)))
      for i in $(seq 0 $((replica_count - 1))); do
        host="replica-${i}.{{ include "cockroach.name" . }}.${loc}.${GVC}.cpln.local"
        if [[ "$host" != "$SELF_FQDN" ]]; then
          JOIN_HOSTS="${JOIN_HOSTS},${host}"
        fi
      done
      loc_index=$((loc_index + 1))
    done

    JOIN_HOSTS=${JOIN_HOSTS#,}  # trim leading comma

    echo "Starting CockroachDB on $SELF_FQDN with join [$JOIN_HOSTS]"

    cmd=(
      cockroach start \
        --insecure \
        --listen-addr=0.0.0.0:26257 \
        --http-addr=0.0.0.0:8080 \
        --advertise-addr="$SELF_FQDN" \
        --join="$JOIN_HOSTS" \
        --cluster-name={{ include "cockroach.name" . }} \
        --locality=region=${LOCATION} \
        --background
    )
    echo "Running: ${cmd[*]}"
    "${cmd[@]}"

    # Cluster init only for replica-0 of first location
    FIRST_LOCATION="{{ (index .Values.gvc.locations 0).name }}"
    if [[ "$REPLICA_INDEX" == "0" && "$LOCATION" == "$FIRST_LOCATION" ]]; then
      echo "Attempting cluster initialization..."

      MAX_ATTEMPTS=20
      ATTEMPT=1
      SUCCESS=false
      FRESH_INIT=false   # <── NEW FLAG

      while [[ $ATTEMPT -le $MAX_ATTEMPTS ]]; do

        set +e
        OUTPUT=$(cockroach init --insecure --host="$SELF_FQDN:26257" --cluster-name={{ include "cockroach.name" . }} 2>&1)
        EXIT_CODE=$?
        set -e

        echo "Init attempt $ATTEMPT: $OUTPUT"
            
        # Check for successful initialization (exit code 0) OR already initialized state.
        ALREADY_INITIALIZED=$(echo "$OUTPUT" | tr -d '\r' | grep -qiE "already.*initialized" && echo "true" || echo "false")

        if [[ $EXIT_CODE -eq 0 ]]; then
          echo "Cluster initialization succeeded."
          SUCCESS=true
          FRESH_INIT=true     # <── NEW
          break
        elif [[ "$ALREADY_INITIALIZED" == "true" ]]; then
          echo "Cluster already initialized — skipping init."
          SUCCESS=true
          FRESH_INIT=false    # <── NEW
          break
        fi
            
        echo "Init not ready yet — retrying in 3s..."
        sleep 3
        ((ATTEMPT++))
      done

      if [[ "$SUCCESS" == true && "$FRESH_INIT" == true ]]; then   # <── WRAPS ENTIRE SETUP SECTION
        echo "Proceeding to database/user creation..."
        cockroach sql --insecure --host="$SELF_FQDN:26257" <<EOF
          CREATE DATABASE IF NOT EXISTS {{ .Values.database.name }};
          CREATE USER IF NOT EXISTS {{ .Values.database.user }};
          GRANT ALL ON DATABASE {{ .Values.database.name }} TO {{ .Values.database.user }};
          ALTER DATABASE {{ .Values.database.name }} PRIMARY REGION "$FIRST_LOCATION";
    EOF

        echo "Waiting for region metadata to propagate..."

        EXPECTED_COUNT=$(echo $LOCATIONS | wc -w)
        TIMEOUT=120
        WAITED=0

        while true; do
          REGISTERED_COUNT=$(cockroach sql --insecure --host="$SELF_FQDN:26257" --format=csv -e \
            "SELECT COUNT(DISTINCT region) FROM [SHOW REGIONS FROM CLUSTER];" | tail -n1)

          echo "Regions detected: $REGISTERED_COUNT / $EXPECTED_COUNT"

          if [[ "$REGISTERED_COUNT" -eq "$EXPECTED_COUNT" ]]; then
            echo "All cluster regions detected."
            break
          fi

          if [[ $WAITED -ge $TIMEOUT ]]; then
            echo "WARNING: Timeout waiting for region propagation — continuing."
            break
          fi
              
          sleep 5
          WAITED=$((WAITED+5))
        done

        for loc in $LOCATIONS; do
          if [[ "$loc" != "$FIRST_LOCATION" ]]; then
            echo "Adding region: $loc"
            cockroach sql --insecure --host="$SELF_FQDN:26257" <<EOF
    ALTER DATABASE {{ .Values.database.name }} ADD REGION "$loc";
    EOF
            for i in {1..30}; do
              registered=$(cockroach sql --insecure --host="$SELF_FQDN:26257" --format=csv -e \
                "SELECT COUNT(*) FROM [SHOW REGIONS FROM CLUSTER] WHERE region = '$loc';" | tail -n1)

              if [[ "$registered" == "1" ]]; then
                echo "Region $loc registered successfully."
                break
              fi

              echo "Waiting for region propagation ($i)..."
              sleep 2
            done
          fi
        done

        echo "Setting survival goal..."
        cockroach sql --insecure --host="$SELF_FQDN:26257" <<EOF
    ALTER DATABASE {{ .Values.database.name }} SURVIVE REGION FAILURE;
    EOF

        echo "Multi-region configuration complete."

      elif [[ "$SUCCESS" == true && "$FRESH_INIT" == false ]]; then
        echo "Existing cluster detected — skipping region & DB configuration."
      else
        echo "ERROR: Failed to initialize cluster after $MAX_ATTEMPTS attempts."
      fi

    else
      echo "Init skipped"
    fi

    echo "CockroachDB is running"
    sleep infinity
---
kind: secret
name: {{ include "cockroach.secretDatabaseName" . }}
description: CockroachDB config
tags: {{- include "cockroach.tags" . | nindent 4 }}
type: dictionary
data:
  db: {{ .Values.database.name }}
  user: {{ .Values.database.user }}
