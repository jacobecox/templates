kind: workload
name: {{ .Release.Name }}-ingester-main
description: Manticore ingester main
tags: {{- include "manticore.tags" . | nindent 4 }}
spec:
  type: cron
  containers:
    - name: manticore-ingester
      cpu: {{ .Values.ingester.main.resources.cpu }}
      env:
        - name: ARTIFACT_BUCKET
          value: {{ .Values.buckets.artifactBucket }}
        - name: ARTIFACT_PREFIX
          value: {{ .Values.buckets.mainArtifactPrefix }}
        - name: AWS_REGION
          value: {{ .Values.buckets.awsRegion }}
        - name: BUILD_TYPE
          value: main
        - name: CSV_PATH
          value: {{ .Values.ingester.main.csvPath }}
        - name: DATASET
          value: {{ .Values.buckets.dataset }}
        - name: SOURCE_BUCKET
          value: {{ .Values.buckets.sourceBucket }}
      image: {{ .Values.ingester.main.image }}
      inheritEnv: false
      memory: {{ .Values.ingester.main.resources.memory }}
      volumes:
        - path: /etc/manticore/manticore.conf
          recoveryPolicy: retain
          uri: cpln://secret/{{ .Release.Name }}-ingester-conf.payload
  defaultOptions:
    capacityAI: false
    debug: false
    suspend: false
    timeoutSeconds: 5
  firewallConfig:
    external:
      inboundAllowCIDR: []
      inboundBlockedCIDR: []
      outboundAllowCIDR:
        - 0.0.0.0/0
      outboundAllowHostname: []
      outboundAllowPort: []
      outboundBlockedCIDR: []
  identityLink: //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-manticore-identity
  job:
    concurrencyPolicy: Forbid
    historyLimit: 5
    restartPolicy: Never
    schedule: {{ .Values.ingester.main.jobSchedule }}
  supportDynamicTags: false