kind: secret
name: {{ .Release.Name }}-manticore-startup
description: Manticore startup script
tags: {{- include "manticore.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: >-
    #!/usr/bin/env bash

    set -euo pipefail

    # CONFIGURATION

    CLUSTER_NAME="{{ .Values.manticore.clusterName }}"
    MYSQL_PORT=9306
    REPL_PORT=9312
    WORKLOAD_NAME="$(echo "${HOSTNAME}" | sed 's/-[0-9]*$//')"
    REPLICA_INDEX="$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')"
    LOCATION=$(basename "${CPLN_LOCATION}")
    NODE0_FQDN="replica-0.${WORKLOAD_NAME}.${LOCATION}.${CPLN_GVC}.cpln.local"
    NODE0_ADDR="${NODE0_FQDN}:${REPL_PORT}"

    echo "  replica 0  = ${NODE0_ADDR}"

    mkdir -p /var/lib/manticore/binlog
    mkdir -p /var/lib/manticore/main
    mkdir -p /var/lib/manticore/rt

    # HELPER FUNCTIONS

    # Execute a MySQL command against Manticore

    mysql_exec() {
      local host="${1:-127.0.0.1}"
      shift || true
      mysql --protocol=tcp -h "${host}" -P "${MYSQL_PORT}" -N -s "$@"
    }

    # Wait until searchd is accepting MySQL connections

    wait_for_manticore() {
      echo "Waiting for Manticore MySQL port ${MYSQL_PORT}..."

      for i in $(seq 1 60); do
        if mysql --protocol=tcp \
                -h 127.0.0.1 \
                -P "${MYSQL_PORT}" \
                -e "SELECT 1" >/dev/null 2>&1; then

          echo "Manticore is ready."

          return 0
        fi

        echo "  [$i/60] not ready yet..."

        sleep 1
      done

      echo "ERROR: Manticore did not become ready on ${MYSQL_PORT}"
      return 1
    }


    # GRACEFUL SHUTDOWN HANDLER

    shutdown() {
      echo "SIGTERM received: graceful shutdown for replica-${REPLICA_INDEX}"

      # Stop searchd (child of this script)

      if [[ -n "${SEARCHD_PID:-}" ]] && kill -0 "$SEARCHD_PID" >/dev/null 2>&1; then

        echo "Stopping searchd (pid=$SEARCHD_PID)..."

        kill "$SEARCHD_PID" || true

        # Give searchd time to exit cleanly

        for _ in $(seq 1 30); do
          kill -0 "$SEARCHD_PID" >/dev/null 2>&1 || break
          sleep 1
        done
      fi


      # INSERT STARTUP VS SCALEDOWN CHECK HERE


      # Remove local replication metadata

      rm -f /var/lib/manticore/manticore.json || true

      # Tell the cluster to recompute membership

      if [[ "$REPLICA_INDEX" != "0" ]]; then
        echo "Requesting cluster node refresh on replica-0..."

        mysql_exec "${NODE0_FQDN}" \
          -e "ALTER CLUSTER ${CLUSTER_NAME} UPDATE nodes" || true
      else

        echo "Replica-0 shutting down; cluster refresh will occur after others exit."

      fi

      echo "Shutdown sequence complete."
    }

    trap shutdown TERM INT


    # START MANTICORE

    echo "Starting searchd..."

    searchd --config /etc/manticore/manticore.conf --nodetach &

    SEARCHD_PID="$!"

    wait_for_manticore

    # CLUSTER BOOTSTRAP / JOIN

    if [[ "$REPLICA_INDEX" == "0" ]]; then

      echo "Replica-0: bootstrapping cluster ${CLUSTER_NAME}"

      mysql_exec 127.0.0.1 -e "CREATE CLUSTER ${CLUSTER_NAME}" || true

      echo "Creating plain main table..."

      mysql_exec 127.0.0.1 <<SQL

    CREATE TABLE IF NOT EXISTS {{ .Values.buckets.dataset }}_main (
      id UINT
    );

    SQL

    echo "Creating replicated RT delta table..."

      mysql_exec 127.0.0.1 <<SQL

    CREATE TABLE {{ .Values.buckets.dataset }}_delta (
      id UINT
    )

    TYPE = rt

    WITH rt_mem_limit = '256M';

    SQL

    for i in $(seq 1 30); do
      if mysql_exec 127.0.0.1 -e "SHOW STATUS LIKE 'cluster_status'" | grep -q running; then
        break
      fi
      sleep 1
    done

      echo "Adding delta table to cluster..."

      mysql_exec 127.0.0.1 \
        -e "ALTER CLUSTER {{ .Values.manticore.clusterName }} ADD {{ .Values.buckets.dataset }}_delta;" || true

      echo "Creating distributed table..."

      mysql_exec 127.0.0.1 <<SQL
    CREATE TABLE IF NOT EXISTS {{ .Values.buckets.dataset }} (
      id UINT
    )
    TYPE = distributed
    LOCAL = {{ .Values.buckets.dataset }}_main*
    LOCAL = {{ .Values.buckets.dataset }}_delta*;

    SQL

    else
      echo "Replica-${REPLICA_INDEX}: joining cluster"

      mysql_exec 127.0.0.1 \
        -e "JOIN CLUSTER ${CLUSTER_NAME} AT '${NODE0_ADDR}'" || true
    fi

    echo "Startup complete. searchd pid=${SEARCHD_PID}"

    # KEEP CONTAINER ALIVE

    wait "$SEARCHD_PID"