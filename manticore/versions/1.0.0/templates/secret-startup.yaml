kind: secret
name: {{ .Release.Name }}-manticore-startup
description: Manticore startup script
tags: {{- include "manticore.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: >-
    #!/usr/bin/env bash

    set -euo pipefail

    # =============================================================================
    # CONFIGURATION
    # =============================================================================

    CLUSTER_NAME="{{ .Values.manticore.clusterName }}"
    DATASET="{{ .Values.buckets.dataset }}"
    MYSQL_PORT=9306
    REPL_PORT=9312
    WORKLOAD_NAME="$(echo "${HOSTNAME}" | sed 's/-[0-9]*$//')"
    REPLICA_INDEX="$(echo "${HOSTNAME}" | awk -F'-' '{print $NF}')"
    LOCATION=$(basename "${CPLN_LOCATION}")
    NODE0_FQDN="replica-0.${WORKLOAD_NAME}.cpln-workload.${CPLN_GVC}.cpln.local"
    NODE0_ADDR="${NODE0_FQDN}:${REPL_PORT}"
    MARKER_FILE="/var/lib/manticore/.last_import"
    S3_MOUNT="/mnt/s3"
    IMPORT_DIR="/var/lib/manticore/import"
    CSV_PATH="{{ .Values.import.csvPath }}"
    EXPECTED_REPLICAS="{{ .Values.manticore.autoscaling.minScale }}"

    echo "============================================"
    echo "Manticore Startup"
    echo "============================================"
    echo "Hostname:       ${HOSTNAME}"
    echo "Replica Index:  ${REPLICA_INDEX}"
    echo "Cluster:        ${CLUSTER_NAME}"
    echo "Dataset:        ${DATASET}"
    echo "Node 0 FQDN:    ${NODE0_FQDN}"
    echo "Node 0 Addr:    ${NODE0_ADDR}"
    echo "S3 Mount:       ${S3_MOUNT}"
    echo "CSV Path:       ${CSV_PATH}"
    echo "============================================"
    echo ""

    # Create required directories
    mkdir -p /var/lib/manticore/binlog
    mkdir -p /var/lib/manticore/main
    mkdir -p /var/lib/manticore/rt
    mkdir -p "${IMPORT_DIR}"

    # =============================================================================
    # HELPER FUNCTIONS
    # =============================================================================

    mysql_exec() {
      local host="${1:-127.0.0.1}"
      shift || true
      mysql --protocol=tcp -h "${host}" -P "${MYSQL_PORT}" -N -s "$@"
    }

    wait_for_manticore() {
      echo "Waiting for Manticore MySQL port ${MYSQL_PORT}..."

      for i in $(seq 1 60); do
        if mysql --protocol=tcp \
                -h 127.0.0.1 \
                -P "${MYSQL_PORT}" \
                -e "SELECT 1" >/dev/null 2>&1; then

          echo "Manticore is ready."

          return 0
        fi

        echo "  [$i/60] not ready yet..."

        sleep 1
      done

      echo "ERROR: Manticore did not become ready on ${MYSQL_PORT}"
      return 1
    }

    wait_for_table() {
      local table="$1"
      local max_wait="${2:-60}"

      echo "Waiting for table ${table} to exist..."

      for i in $(seq 1 ${max_wait}); do
        if mysql_exec 127.0.0.1 -e "SHOW TABLES LIKE '${table}'" 2>/dev/null | grep -q "${table}"; then
          echo "Table ${table} exists."
          return 0
        fi
        echo "  [$i/${max_wait}] table not found yet..."
        sleep 1
      done

      echo "WARNING: Table ${table} not found after ${max_wait}s"
      return 1
    }

    # =============================================================================
    # IMPORT FUNCTIONS
    # =============================================================================

    do_import() {
      local source_file="$1"
      local s3_modified="$2"

      echo "Starting import for ${source_file} (mtime: ${s3_modified})"

      # Check marker - skip if already imported this version
      if [[ -f "${MARKER_FILE}" ]] && [[ "$(cat ${MARKER_FILE})" == "${s3_modified}" ]]; then
        echo "Already imported this version. Skipping."
        return 0
      fi

      # Verify file exists on S3 mount
      local src_path="${S3_MOUNT}/${source_file}"
      if [[ ! -f "${src_path}" ]]; then
        echo "ERROR: File not found: ${src_path}"
        return 1
      fi

      # Copy from S3 mount to import directory (indexer needs local file)
      echo "Copying ${src_path} to ${IMPORT_DIR}/data.csv..."
      cp "${src_path}" "${IMPORT_DIR}/data.csv" || return 1

      # Run indexer to build plain index
      echo "Running indexer for ${DATASET}_main..."
      indexer --rotate "${DATASET}_main" || return 1

      # Update marker
      echo "${s3_modified}" > "${MARKER_FILE}"
      echo "Import completed successfully."
      return 0
    }

    import_watcher() {
      echo "Starting import watcher loop..."

      while true; do
        sleep 10  # Poll interval

        # Query for pending work assigned to this replica
        PENDING=$(mysql_exec 127.0.0.1 -N -e \
            "SELECT import_id, s3_last_modified, source_file FROM _import_signals \
             WHERE replica_id = ${REPLICA_INDEX} AND status = 'pending' \
             ORDER BY import_id ASC LIMIT 1" 2>/dev/null || echo "")

        if [[ -n "${PENDING}" ]]; then
          IMPORT_ID=$(echo "${PENDING}" | cut -f1)
          S3_MODIFIED=$(echo "${PENDING}" | cut -f2)
          SOURCE_FILE=$(echo "${PENDING}" | cut -f3)

          echo ""
          echo "============================================"
          echo "Import signal received (import_id=${IMPORT_ID})"
          echo "============================================"

          # Mark as running
          mysql_exec 127.0.0.1 -e \
              "UPDATE _import_signals SET status='running' \
               WHERE import_id=${IMPORT_ID} AND replica_id=${REPLICA_INDEX}" || true

          # Perform import
          local error_msg=""
          if do_import "${SOURCE_FILE}" "${S3_MODIFIED}"; then
            mysql_exec 127.0.0.1 -e \
                "UPDATE _import_signals SET status='success', completed_at=$(date +%s) \
                 WHERE import_id=${IMPORT_ID} AND replica_id=${REPLICA_INDEX}" || true
            echo "Import signal ${IMPORT_ID} completed successfully."
          else
            error_msg="Import failed"
            mysql_exec 127.0.0.1 -e \
                "UPDATE _import_signals SET status='failed', error_message='${error_msg}', completed_at=$(date +%s) \
                 WHERE import_id=${IMPORT_ID} AND replica_id=${REPLICA_INDEX}" || true
            echo "ERROR: Import signal ${IMPORT_ID} failed."
          fi

          echo "============================================"
          echo ""
        fi
      done
    }

    # =============================================================================
    # GRACEFUL SHUTDOWN HANDLER
    # =============================================================================

    shutdown() {
      echo ""
      echo "============================================"
      echo "SIGTERM received: graceful shutdown"
      echo "============================================"

      # Stop searchd (child of this script)
      if [[ -n "${SEARCHD_PID:-}" ]] && kill -0 "$SEARCHD_PID" >/dev/null 2>&1; then
        echo "Stopping searchd (pid=${SEARCHD_PID})..."
        kill "$SEARCHD_PID" || true

        # Give searchd time to exit cleanly
        for _ in $(seq 1 30); do
          kill -0 "$SEARCHD_PID" >/dev/null 2>&1 || break
          sleep 1
        done
      fi

      # Remove local replication metadata
      rm -f /var/lib/manticore/manticore.json || true

      # Tell the cluster to recompute membership
      if [[ "${REPLICA_INDEX}" != "0" ]]; then
        echo "Requesting cluster node refresh on replica-0..."
        mysql_exec "${NODE0_FQDN}" \
          -e "ALTER CLUSTER ${CLUSTER_NAME} UPDATE nodes" || true
      else
        echo "Replica-0 shutting down; cluster refresh will occur after others exit."
      fi

      echo "Shutdown sequence complete."
      echo "============================================"
    }

    trap shutdown TERM INT

    # =============================================================================
    # START MANTICORE
    # =============================================================================

    echo "Starting searchd..."

    searchd --config /etc/manticore/manticore.conf --nodetach &

    SEARCHD_PID="$!"

    wait_for_manticore

    # =============================================================================
    # CLUSTER BOOTSTRAP / JOIN
    # =============================================================================

    if [[ "${REPLICA_INDEX}" == "0" ]]; then

      echo ""
      echo "============================================"
      echo "Replica-0: Bootstrapping cluster"
      echo "============================================"

      mysql_exec 127.0.0.1 -e "CREATE CLUSTER ${CLUSTER_NAME}" || true

      # Create import signals RT table (replicated across cluster)
      echo "Creating _import_signals table..."
      mysql_exec 127.0.0.1 <<SQL || true
    CREATE TABLE IF NOT EXISTS _import_signals (
        import_id       BIGINT,
        replica_id      INTEGER,
        s3_last_modified BIGINT,
        source_file     TEXT,
        status          TEXT,
        error_message   TEXT,
        created_at      BIGINT,
        completed_at    BIGINT
    ) TYPE='rt';
    SQL

      # Wait for cluster to be ready before adding table
      echo "Waiting for cluster to be ready..."
      for i in $(seq 1 30); do
        if mysql_exec 127.0.0.1 -e "SHOW STATUS LIKE 'cluster_${CLUSTER_NAME}_status'" 2>/dev/null | grep -q "primary"; then
          break
        fi
        sleep 1
      done

      echo "Adding _import_signals to cluster..."
      mysql_exec 127.0.0.1 \
        -e "ALTER CLUSTER ${CLUSTER_NAME} ADD _import_signals" || true

      # Create RT delta table for realtime data
      echo "Creating ${DATASET}_delta RT table..."
      mysql_exec 127.0.0.1 <<SQL || true
    CREATE TABLE IF NOT EXISTS ${DATASET}_delta (
        id BIGINT
    ) TYPE='rt';
    SQL

      echo "Adding ${DATASET}_delta to cluster..."
      mysql_exec 127.0.0.1 \
        -e "ALTER CLUSTER ${CLUSTER_NAME} ADD ${DATASET}_delta" || true

      # Execute custom DDL if provided
      if [[ -f /etc/manticore/custom-ddl.sql ]]; then
        echo "Executing custom DDL..."
        mysql_exec 127.0.0.1 < /etc/manticore/custom-ddl.sql || true
      fi

      # Check if this is first boot (no successful imports yet)
      IMPORT_COUNT=$(mysql_exec 127.0.0.1 -N -e \
          "SELECT COUNT(*) FROM _import_signals WHERE status='success'" 2>/dev/null || echo "0")

      if [[ "${IMPORT_COUNT}" == "0" ]]; then
        echo ""
        echo "First boot detected - triggering initial import..."

        # Check if S3 file exists
        if [[ -f "${S3_MOUNT}/${CSV_PATH}" ]]; then
          S3_MODIFIED=$(stat -c %Y "${S3_MOUNT}/${CSV_PATH}")
          IMPORT_ID=$(date +%s)
          NOW=${IMPORT_ID}

          echo "Creating initial import signals for ${EXPECTED_REPLICAS} replicas..."
          for ((i=0; i<EXPECTED_REPLICAS; i++)); do
            mysql_exec 127.0.0.1 -e \
                "INSERT INTO _import_signals (import_id, replica_id, s3_last_modified, source_file, status, created_at) \
                 VALUES (${IMPORT_ID}, ${i}, ${S3_MODIFIED}, '${CSV_PATH}', 'pending', ${NOW})" || true
          done
          echo "Initial import signals created (import_id=${IMPORT_ID})"
        else
          echo "WARNING: S3 file not found at ${S3_MOUNT}/${CSV_PATH}"
          echo "Initial import will be triggered when cron runs after file is available."
        fi
      fi

      echo "============================================"

    else

      echo ""
      echo "============================================"
      echo "Replica-${REPLICA_INDEX}: Joining cluster"
      echo "============================================"

      # Wait for _import_signals table to exist (indicates cluster is ready)
      wait_for_table "_import_signals" 120 || true

      echo "Joining cluster at ${NODE0_ADDR}..."
      mysql_exec 127.0.0.1 \
        -e "JOIN CLUSTER ${CLUSTER_NAME} AT '${NODE0_ADDR}'" || true

      echo "============================================"

    fi

    # =============================================================================
    # START IMPORT WATCHER
    # =============================================================================

    echo ""
    echo "Starting background import watcher..."
    import_watcher &
    WATCHER_PID="$!"

    echo ""
    echo "============================================"
    echo "Startup complete"
    echo "============================================"
    echo "searchd PID: ${SEARCHD_PID}"
    echo "watcher PID: ${WATCHER_PID}"
    echo "============================================"
    echo ""

    # =============================================================================
    # KEEP CONTAINER ALIVE
    # =============================================================================

    wait "${SEARCHD_PID}"
