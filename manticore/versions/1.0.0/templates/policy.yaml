# =============================================================================
# Access Policies
# =============================================================================
# Defines permissions for workload identities to access secrets and workloads.
# The orchestrator architecture requires:
#   1. Secret access for configuration files and auth tokens
#   2. Workload exec permission for triggering cron jobs
#   3. Workload view permission for reading replica configuration

# Secret access policy - grants reveal permission on configuration secrets
# Used by both manticore (agent sidecar) and orchestrator workloads
kind: policy
name: {{ .Release.Name }}-manticore-config-policy
description: Secret access for manticore and orchestrator workloads
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - reveal
    principalLinks:
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-manticore-identity
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-orchestrator-identity
targetKind: secret
targetLinks:
  - //secret/{{ .Release.Name }}-manticore-conf
  - //secret/{{ .Release.Name }}-manticore-startup
  - //secret/{{ .Release.Name }}-manticore-schema
  - //secret/{{ .Release.Name }}-manticore-custom-ddl
  - //secret/{{ .Release.Name }}-agent-token
targetQuery:
  kind: secret
  fetch: items
  spec:
    match: all
    terms: []
---
# Cron execution policy - allows triggering orchestrator jobs via CPLN API
# The orchestrator API and agents can trigger import/init/repair actions
kind: policy
name: {{ .Release.Name }}-manticore-exec-policy
description: Permission to trigger orchestrator cron workload executions
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - view
      - exec.runCronWorkload
    principalLinks:
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-manticore-identity
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-orchestrator-identity
targetKind: workload
targetLinks:
  - //gvc/{{ .Values.global.cpln.gvc }}/workload/{{ .Release.Name }}-orchestrator
---
# Workload view policy - allows orchestrator to read Manticore workload config
# Used to discover replica count, endpoints, and configuration
kind: policy
name: {{ .Release.Name }}-orchestrator-workload-policy
description: Permission to view Manticore workload configuration
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - view
    principalLinks:
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-orchestrator-identity
targetKind: workload
targetLinks:
  - //gvc/{{ .Values.global.cpln.gvc }}/workload/{{ .Release.Name }}-manticore
{{- if .Values.loadTest.enabled }}
---
# Load test script access - allows k6 workload to read test script
kind: policy
name: {{ .Release.Name }}-load-test
description: K6 workload access to load test script secret
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - use
      - reveal
    principalLinks:
      - //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-load-test
targetKind: secret
targetLinks:
  - //secret/{{ .Release.Name }}-k6-script
---
# Load test controller policy - allows scaling the k6 workload
kind: policy
name: {{ .Release.Name }}-load-test-controller
description: Controller permission to scale load-test workload
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - manage
      - edit
    principalLinks:
      - //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-load-test-controller
targetKind: workload
targetLinks:
  - //gvc/{{ .Values.global.cpln.gvc }}/workload/{{ .Release.Name }}-load-test
{{- end }}
