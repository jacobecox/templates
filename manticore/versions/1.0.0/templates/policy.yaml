# =============================================================================
# Access Policies
# =============================================================================
# Defines permissions for workload identities to access secrets and workloads.
# The orchestrator architecture requires:
#   1. Secret access for configuration files and auth tokens
#   2. Workload exec permission for triggering cron jobs
#   3. Workload view permission for reading replica configuration

# Secret access policy - grants reveal permission on configuration secrets
# Used by both manticore (agent sidecar) and orchestrator workloads
kind: policy
name: {{ include "manticore.configPolicyName" . }}
description: Secret access for manticore and orchestrator workloads
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - reveal
    principalLinks:
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.identityName" . }}
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.orchestratorIdentityName" . }}
targetKind: secret
targetLinks:
  - //secret/{{ include "manticore.secretConfigName" . }}
  - //secret/{{ include "manticore.secretStartupName" . }}
  - //secret/{{ include "manticore.secretSchemaConfigName" . }}
  - //secret/{{ include "manticore.secretCustomDDLName" . }}
  - //secret/{{ include "manticore.secretAgentTokenName" . }}
targetQuery:
  kind: secret
  fetch: items
  spec:
    match: all
    terms: []
---
# Cron execution policy - allows triggering orchestrator jobs via CPLN API
# The orchestrator API and agents can trigger import/init/repair actions
kind: policy
name: {{ include "manticore.execPolicyName" . }}
description: Permission to trigger orchestrator cron workload executions
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - view
      - exec.runCronWorkload
    principalLinks:
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.identityName" . }}
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.orchestratorIdentityName" . }}
targetKind: workload
targetLinks:
  - //gvc/{{ .Values.global.cpln.gvc }}/workload/{{ include "manticore.orchestratorJobName" . }}
---
# Workload view policy - allows orchestrator to read Manticore workload config
# Used to discover replica count, endpoints, and configuration
kind: policy
name: {{ include "manticore.orchestratorPolicyName" . }}
description: Permission to view Manticore workload configuration
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - view
    principalLinks:
      - /org/{{ .Values.global.cpln.org }}/gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.orchestratorIdentityName" . }}
targetKind: workload
targetLinks:
  - //gvc/{{ .Values.global.cpln.gvc }}/workload/{{ include "manticore.name" . }}
{{- if .Values.loadTest.enabled }}
---
# Load test script access - allows k6 workload to read test script
kind: policy
name: {{ include "manticore.loadTestPolicyName" . }}
description: K6 workload access to load test script secret
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - use
      - reveal
    principalLinks:
      - //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.loadTestIdentityName" . }}
targetKind: secret
targetLinks:
  - //secret/{{ include "manticore.secretK6ScriptName" . }}
---
# Load test controller policy - allows scaling the k6 workload
kind: policy
name: {{ include "manticore.loadTestControllerPolicyName" . }}
description: Controller permission to scale load-test workload
tags: {{- include "manticore.tags" . | nindent 4 }}
bindings:
  - permissions:
      - manage
      - edit
    principalLinks:
      - //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ include "manticore.loadTestControllerIdentityName" . }}
targetKind: workload
targetLinks:
  - //gvc/{{ .Values.global.cpln.gvc }}/workload/{{ include "manticore.loadTestName" . }}
{{- end }}
