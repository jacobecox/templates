kind: secret
name: {{ .Release.Name }}-import-trigger
description: Import trigger script for cron workload
tags: {{- include "manticore.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    # =============================================================================
    # Import Trigger Script
    # =============================================================================
    # This script runs as a cron job and triggers S3 imports on all replicas.
    # It creates per-replica signal rows and waits for all replicas to complete.
    # =============================================================================

    S3_MOUNT="/mnt/s3"

    mysql_exec() {
        mysql --protocol=tcp -h "${CLUSTER_ENDPOINT}" -P "${MYSQL_PORT}" -N -s "$@"
    }

    echo "============================================"
    echo "Import Trigger Starting"
    echo "============================================"
    echo "CSV_PATH: ${CSV_PATH}"
    echo "REPLICA_COUNT: ${REPLICA_COUNT}"
    echo "CLUSTER_ENDPOINT: ${CLUSTER_ENDPOINT}"
    echo ""

    # Check if the CSV file exists on the S3 mount
    CSV_FILE="${S3_MOUNT}/${CSV_PATH}"

    if [[ ! -f "$CSV_FILE" ]]; then
        echo "ERROR: File not found: ${CSV_FILE}"
        echo "Available files in S3 mount:"
        ls -la "${S3_MOUNT}/" 2>/dev/null || echo "  (unable to list)"
        exit 1
    fi

    # Get file modification time as unix timestamp
    LAST_MODIFIED=$(stat -c %Y "$CSV_FILE")
    echo "File: ${CSV_FILE}"
    echo "Last Modified: ${LAST_MODIFIED} ($(date -d @${LAST_MODIFIED} 2>/dev/null || date -r ${LAST_MODIFIED}))"
    echo ""

    # Check if we already imported this version
    echo "Checking for previous successful imports..."
    LAST_SUCCESS=$(mysql_exec -e \
        "SELECT COALESCE(MAX(s3_last_modified), 0) FROM _import_signals WHERE status='success'" 2>/dev/null || echo "0")

    echo "Last successful import timestamp: ${LAST_SUCCESS}"

    if [[ "${LAST_SUCCESS}" == "${LAST_MODIFIED}" ]]; then
        echo ""
        echo "No changes detected. Skipping import."
        echo "============================================"
        exit 0
    fi

    echo ""
    echo "Change detected! Triggering import on ${REPLICA_COUNT} replicas..."
    echo ""

    IMPORT_ID=$(date +%s)
    NOW=${IMPORT_ID}

    # Create one row per replica with status='pending'
    for ((i=0; i<REPLICA_COUNT; i++)); do
        echo "Creating signal for replica-${i}..."
        mysql_exec -e \
            "INSERT INTO _import_signals (import_id, replica_id, s3_last_modified, source_file, status, created_at) \
             VALUES (${IMPORT_ID}, ${i}, ${LAST_MODIFIED}, '${CSV_PATH}', 'pending', ${NOW})"
    done

    echo ""
    echo "Created ${REPLICA_COUNT} import signals (import_id=${IMPORT_ID})"
    echo "Waiting for replicas to complete..."
    echo ""

    # Poll for completion
    ELAPSED=0
    while [[ ${ELAPSED} -lt ${POLL_TIMEOUT} ]]; do
        sleep ${POLL_INTERVAL}
        ELAPSED=$((ELAPSED + POLL_INTERVAL))

        # Check for pending/running
        INCOMPLETE=$(mysql_exec -e \
            "SELECT COUNT(*) FROM _import_signals \
             WHERE import_id=${IMPORT_ID} AND status IN ('pending', 'running')")

        if [[ "${INCOMPLETE}" == "0" ]]; then
            break
        fi

        # Show current status
        echo "[${ELAPSED}s] Waiting... ${INCOMPLETE} replicas still processing"
        mysql_exec -e \
            "SELECT CONCAT('  replica-', replica_id, ': ', status) FROM _import_signals \
             WHERE import_id=${IMPORT_ID}" 2>/dev/null || true
    done

    echo ""
    echo "Checking final results..."
    echo ""

    # Check final results
    FAILED=$(mysql_exec -e \
        "SELECT CONCAT('replica-', replica_id, ': ', COALESCE(error_message, 'unknown error')) \
         FROM _import_signals \
         WHERE import_id=${IMPORT_ID} AND status='failed'" 2>/dev/null || echo "")

    TIMEOUT_COUNT=$(mysql_exec -e \
        "SELECT COUNT(*) FROM _import_signals \
         WHERE import_id=${IMPORT_ID} AND status IN ('pending', 'running')" 2>/dev/null || echo "0")

    SUCCESS_COUNT=$(mysql_exec -e \
        "SELECT COUNT(*) FROM _import_signals \
         WHERE import_id=${IMPORT_ID} AND status='success'" 2>/dev/null || echo "0")

    echo "Results:"
    echo "  Success: ${SUCCESS_COUNT}"
    echo "  Failed: $(echo "${FAILED}" | grep -c . || echo 0)"
    echo "  Timeout: ${TIMEOUT_COUNT}"
    echo ""

    if [[ -n "${FAILED}" ]]; then
        echo "ERROR: Some replicas failed:"
        echo "${FAILED}"
        echo ""
        echo "============================================"
        exit 1
    fi

    if [[ "${TIMEOUT_COUNT}" != "0" ]]; then
        echo "ERROR: ${TIMEOUT_COUNT} replicas did not respond within timeout (${POLL_TIMEOUT}s)"
        mysql_exec -e \
            "SELECT CONCAT('  replica-', replica_id, ': ', status) FROM _import_signals \
             WHERE import_id=${IMPORT_ID} AND status IN ('pending', 'running')" 2>/dev/null || true
        echo ""
        echo "============================================"
        exit 1
    fi

    echo "SUCCESS: All ${REPLICA_COUNT} replicas completed import"
    echo "============================================"
    exit 0
