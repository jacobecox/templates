{{- if .Values.proxy.enabled }}
kind: secret
name: {{ .Release.Name }}-postgres-proxy-startup
description: HAProxy startup script for Postgres Highly Available
tags:
  {{- include "pg-ha.tags" . | nindent 4 }}
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env sh
    set -eu

    LOCATION="$(basename "${CPLN_LOCATION:-}")"
    if [ -z "${LOCATION}" ]; then
      echo "ERROR: CPLN_LOCATION is empty; cannot derive location"
      exit 1
    fi

    GVC="{{ .Values.global.cpln.gvc }}"
    WORKLOAD="{{ .Release.Name }}-postgres-ha"
    REPLICAS="{{ .Values.replicas }}"

    echo "Starting HAProxy Patroni leader proxy"
    echo "Derived location: ${LOCATION}"
    echo "Target workload: ${WORKLOAD}"
    echo "Replicas: ${REPLICAS}"

    CFG="/tmp/haproxy.cfg"

    SERVERS=""
    i=0
    while [ "${i}" -lt "${REPLICAS}" ]; do
      HOST="replica-${i}.${WORKLOAD}.${LOCATION}.${GVC}.cpln.local"
      SERVERS="${SERVERS}
      server pg${i} ${HOST}:5432 check"
      i=$((i + 1))
    done

    cat > "${CFG}" <<EOF
    global
      log stdout format raw local0
      maxconn 4096

    defaults
      mode tcp
      log global
      option tcplog
      timeout connect 5s
      timeout client  2m
      timeout server  2m
      timeout check   5s

    frontend postgres_primary
      bind *:5432
      default_backend patroni_primary

    backend patroni_primary
      mode tcp
      option tcp-check
      default-server inter 2s fall 5 rise 2 on-marked-down shutdown-sessions

      # Patroni leader check on :8008
      tcp-check connect port 8008
      tcp-check send "GET /primary HTTP/1.1\r\nHost: patroni\r\nConnection: close\r\n\r\n"
      tcp-check expect rstring "HTTP/1\\.[01] 200"

    ${SERVERS}
    EOF

    echo "Rendered HAProxy config:"
    cat "${CFG}"

    # validate config before start (optional but nice)
    haproxy -c -f "${CFG}"

    exec haproxy -W -db -f "${CFG}"
{{- end }}