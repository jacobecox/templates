{{- if .Values.proxy.enabled }}
kind: workload
name: {{ .Release.Name }}-postgres-ha-proxy
description: HAProxy leader-only endpoint for Patroni Postgres
tags:
  {{- include "pg-ha.tags" . | nindent 4 }}
spec:
  type: standard
  containers:
    - name: haproxy
      image: {{ .Values.proxy.image }}
      inheritEnv: false
      command: /bin/sh
      args:
        - /proxy/start.sh
      cpu: {{ .Values.proxy.resources.cpu }}
      memory: {{ .Values.proxy.resources.memory }}
      ports:
        - number: 5432
          protocol: tcp
      volumes:
        - path: /proxy/start.sh
          uri: cpln://secret/{{ .Release.Name }}-postgres-proxy-startup.payload
  identityLink: //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-postgres-ha-identity
  defaultOptions:
    autoscaling:
      metric: rps
      minScale: {{ .Values.proxy.minReplicas }}
      maxScale: {{ .Values.proxy.maxReplicas }}
      maxConcurrency: 0
      scaleToZeroDelay: 300
      target: 100
    capacityAI: false
    debug: false
    multiZone:
      enabled: {{ .Values.multiZone }}
    timeoutSeconds: 5
  firewallConfig:
    internal:
      inboundAllowType: {{ .Values.internal_access.type }}
      {{- if .Values.internal_access.workloads }}
      inboundAllowWorkload: {{ .Values.internal_access.workloads | toYaml | nindent 8 }}
      {{- end }}
    external:
      inboundAllowCIDR: []
      outboundAllowCIDR: []
  loadBalancer:
    direct:
      enabled: false
      ports: []
    replicaDirect: false
{{- end }}