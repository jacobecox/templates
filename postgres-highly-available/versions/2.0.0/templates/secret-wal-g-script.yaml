kind: secret
name: {{ .Release.Name }}-wal-g-backup-script
description: WAL-G base backup sidecar script
type: opaque
data:
  encoding: plain
  payload: |-
    #!/usr/bin/env bash
    set -euo pipefail

    : "${PGDATA:?Missing PGDATA}"
    : "${PATRONI_API:=http://127.0.0.1:8008}"
    : "${WALG_BACKUP_INTERVAL_SECONDS:=3600}"

    echo "WAL-G base backup sidecar started"
    echo "PGDATA=${PGDATA}"
    echo "PATRONI_API=${PATRONI_API}"
    echo "Interval=${WALG_BACKUP_INTERVAL_SECONDS}s"

    # small jitter so fleets don't backup at the same second
    sleep $(( RANDOM % 30 ))

    while true; do
      code="$(curl -s -o /dev/null -w "%{http_code}" "${PATRONI_API}/primary" || true)"

      if [ "${code}" = "200" ]; then
        echo "Leader confirmed. Running wal-g backup-push ${PGDATA}"
        wal-g backup-push "${PGDATA}"
        echo "Backup complete"

        # Optional retention (uncomment if you want it)
        # : "${WALG_RETAIN_FULL:=7}"
        # wal-g delete retain FULL "${WALG_RETAIN_FULL}" --confirm || true
      else
        echo "Not leader (/primary=${code}). Skipping backup."
      fi

      sleep "${WALG_BACKUP_INTERVAL_SECONDS}"
    done