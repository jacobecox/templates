kind: workload
name: {{ .Release.Name }}-postgres
gvc: {{ .Values.global.cpln.gvc }}
description: Postgres Database
tags:
  {{- include "pg.tags" . | nindent 2 }}
spec:
  type: stateful
  identityLink: //identity/{{ .Release.Name }}-pg-identity
  containers:
    - name: postgresql
      env:
        - name: PGDATA
          value: "/var/lib/postgresql/data/pg_data"
        - name: POSTGRES_DB
          value: {{ .Values.config.database }}
        - name: POSTGRES_PASSWORD
          value: 'cpln://secret/{{ .Release.Name }}-pg-config.password'
        - name: POSTGRES_USER
          value: 'cpln://secret/{{ .Release.Name }}-pg-config.username'
      image: {{ .Values.image }}
      inheritEnv: false
      minCpu: {{ .Values.resources.minCpu }}
      minMemory: {{ .Values.resources.minMemory }}
      cpu: {{ .Values.resources.maxCpu }}
      memory: {{ .Values.resources.maxMemory }}
      ports:
        - number: 5432
          protocol: tcp
      volumes:
        - path: /var/lib/postgresql/data
          uri: 'cpln://volumeset/{{ .Release.Name }}-pg-vs'
      readinessProbe:
        exec:
          command:
            - sh
            - '-c'
            - 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'
        failureThreshold: 10
        initialDelaySeconds: 17
        periodSeconds: 5
        successThreshold: 1
        timeoutSeconds: 3
  defaultOptions:
    autoscaling:
      metric: disabled
      minScale: 1
      maxScale: 1
    capacityAI: false
  firewallConfig:
    external:
      outboundAllowCIDR:
        - 0.0.0.0/0
    internal:
      inboundAllowType: {{ .Values.internalAccess.type }}
      {{- if .Values.internalAccess.workloads }}
      inboundAllowWorkload: {{ .Values.internalAccess.workloads | toYaml | nindent 8 }}
      {{- end }}
      inboundAllowWorkload: []