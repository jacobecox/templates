{{- if .Values.api.enabled }}
kind: workload
name: {{ .Release.Name }}-task-runner-api
description: Task Runner API - HTTP endpoint for enqueuing tasks
tags: {{- include "cpln-task-runner.tags" . | nindent 4 }}
spec:
  type: serverless

  identityLink: //gvc/{{ .Values.global.cpln.gvc }}/identity/{{ .Release.Name }}-task-runner-identity

  containers:
    - name: api
      image: controlplanecorporation/cpln-task-runner:0.3
      port: {{ .Values.api.port }}

      cpu: {{ .Values.api.resources.cpu | quote }}
      memory: {{ .Values.api.resources.memory | quote }}

      env:
        - name: MODE
          value: "api"
        - name: PORT
          value: {{ .Values.api.port | quote }}
        - name: REDIS_PASSWORD
          value: "cpln://secret/task-runner-secrets.redis-password"
        - name: REDIS_MASTER_NAME
          value: {{ .Values.redis.masterName | quote }}
        - name: REDIS_SENTINEL_ADDR
          value: {{ .Release.Name }}-sentinel.{{ .Values.global.cpln.gvc }}.cpln.local:26379
        - name: REDIS_SENTINEL_PASSWORD
          value: "cpln://secret/task-runner-secrets.redis-sentinel-password"
        - name: LOG_LEVEL
          value: {{ .Values.api.env.logLevel | quote }}
        {{- if .Values.api.env.adminApiKey }}
        - name: ADMIN_API_KEY
          value: "cpln://secret/task-runner-secrets.admin-api-key"
        {{- end }}
        {{- if .Values.api.env.otelEndpoint }}
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: {{ .Values.api.env.otelEndpoint | quote }}
        {{- end }}

      readinessProbe:
        httpGet:
          path: /health/ready
          port: {{ .Values.api.port }}
        initialDelaySeconds: 5
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 3

      livenessProbe:
        httpGet:
          path: /health/live
          port: {{ .Values.api.port }}
        initialDelaySeconds: 10
        periodSeconds: 15
        timeoutSeconds: 5
        failureThreshold: 3

  defaultOptions:
    autoscaling:
      metric: concurrency
      target: 100
      minScale: {{ .Values.api.replicas.min }}
      maxScale: {{ .Values.api.replicas.max }}
      scaleToZeroDelay: 300
    capacityAI: false
    timeoutSeconds: 30

  firewallConfig:
    {{- if .Values.api.public.enabled }}
    external:
      inboundAllowCIDR:
        - 0.0.0.0/0
      {{- if .Values.api.public.pathPrefix }}
      outboundAllowHostname: []
      {{- end }}
    {{- end }}
    internal:
      inboundAllowType: same-gvc
{{- end }}